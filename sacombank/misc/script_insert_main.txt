INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 
    'CASA_SUM_BAL_NOW' FTR_NM,
    SUM(ACTUAL_BAL_LCL) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM
    (SELECT CUSTOMER_CDE,
  ACTUAL_BAL_LCL
 FROM DW_ANALYTICS.DW_DEPOSIT_FCT CS
 WHERE CATEGORY_CDE LIKE '10__'
  AND CUSTOMER_CDE IN
   (SELECT CUSTOMER_CDE 
   FROM CINS_TMP_CUST
   )
  AND PROCESS_DT IN 
   (SELECT MAX(PROCESS_DT)
   FROM DW_ANALYTICS.DW_DEPOSIT_FCT
   WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
    AND CATEGORY_CDE LIKE '10__'
   )
 )
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
select customer_cde, 'CARD_TOP2_MERCHANT_6M' FTR_NM, merchant_cde FTR_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, merchant_cde, 
       count(*) ct_txn_merchant, row_number()over(partition by customer_cde order by count(*) desc) rn1
from
(
select customer_cde, merchant_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn from 
(
 select customer_cde, trim(' ' from(merchant_cde)) merchant_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
 ))
where rn = 1
group by customer_cde, merchant_cde)
where rn1 = 2;



INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 'GENDER' FTR_NM,
CASE WHEN GENDER_CDE = 'MALE' THEN 'MALE'
     WHEN GENDER_CDE = 'FEMALE' OR GENDER_CDE = 'female' THEN 'FEMALE' 
     ELSE 'OTHERS'
     END FTR_VAL,TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP 
FROM DW_ANALYTICS.DW_CUSTOMER_DIM
WHERE SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1' AND TO_DATE(CUS_OPEN_DT) <= TO_DATE('{RPT_DT}','DD-MM-YY') AND CUSTOMER_cde IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
AND UPDATE_DT <= TO_DATE('{RPT_DT}','DD-MM-YY');

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'EB_MBIB_CT_TXN_1M' FTR_NM,
    COUNT(TXN_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_MBIB_CT_TXN_3M' FTR_NM,
    COUNT(TXN_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_MBIB_CT_TXN_6M' FTR_NM,
    COUNT(TXN_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
    AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
select customer_cde,'LOR' FTR_NM,
TO_DATE('{RPT_DT}','DD-MM-YY') - TO_DATE(CUS_OPEN_DT) FTR_VAL, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP
from DW_ANALYTICS.dw_customer_dim
WHERE  SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1' AND TO_DATE(CUS_OPEN_DT) <= TO_DATE('{RPT_DT}','DD-MM-YY') AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST);
COMMIT;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,'CARD_SUM_TXN_AMT_6M' FTR_NM,SUM(ABS(AMT_BILL)) FTR_VAL, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP   from  
(
select customer_cde,cardhdr_no, approval_cde, retrvl_refno, process_dt, amt_bill,
row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno, amt_bill order by process_dt desc) rn
FROM (
select customer_cde,cardhdr_no,  TRIM(' ' FROM (approval_cde)) approval_cde, retrvl_refno, amt_bill, process_dt
      from DW_ANALYTICS.DW_CARD_TRANSACTION_FCT
      where CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
    and tran_status = 'S'
    and process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
    group by customer_cde,cardhdr_no,  TRIM(' ' FROM (approval_cde)), retrvl_refno, amt_bill, process_dt
    )
)
where rn = 1
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 
    'CARD_CREDIT_HOLD' AS FTR_NM,
    '1' AS FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP AS ADD_TSTP
    FROM 
    (
    SELECT DISTINCT CUSTOMER_CDE FROM DW_ANALYTICS.DW_CARD_MASTER_DIM 
    WHERE SUBSTR(CARD_CDE,1,1) = '3' AND STATUS_CDE = ' ' AND BASIC_SUPP_IND = 'B' AND TO_CHAR(LAST_RENEWAL_DT) = '01-JAN-00' 
 AND ACTIVATION_DT <= TO_DATE('{RPT_DT}','DD-MM-YY')
    AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
    );

INSERT INTO {TBL_NM}
select customer_cde, 'CARD_TOP1_MERCHANT_6M' FTR_NM, merchant_cde FTR_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, merchant_cde, 
       count(*) ct_txn_merchant, row_number()over(partition by customer_cde order by count(*) desc) rn1
from
(
select customer_cde, merchant_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn from 
(
 select customer_cde, trim(' ' from(merchant_cde)) merchant_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
 ))
where rn = 1
group by customer_cde, merchant_cde)
where rn1 = 1;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
 'CARD_CREDIT_MAX_LIMIT' AS FTR_NM,
 MAX(TT_CARD_LIMIT) AS FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
 CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DATA_RPT_CARD_493 
WHERE CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
AND SUBSTR(CARD_CDE,1,1) = '3'
AND CARD_CDE IN (SELECT CARD_CDE FROM CINS_TMP_CARD_DIM)
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
GROUP BY CUSTOMER_CDE;



INSERT INTO {TBL_NM}
WITH A AS
(
SELECT CUSTOMER_CDE,
    LAST_SIGNED_ON,
    ROW_NUMBER() OVER (PARTITION BY CUSTOMER_CDE ORDER BY LAST_SIGNED_ON DESC) RN
    FROM DW_ANALYTICS.DW_EWALL_USER_DIM
    WHERE USER_STATUS = 'A'
        AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
)

SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_DAY_SINCE_LTST_LOGIN' AS FTR_NM,
    AVG(TO_DATE('{RPT_DT}','DD-MM-YY') - TO_DATE(LAST_SIGNED_ON)) AS FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
 CURRENT_TIMESTAMP AS ADD_TSTP
    FROM A
    WHERE TO_DATE(LAST_SIGNED_ON) < TO_DATE('{RPT_DT}','DD-MM-YY')
 AND TO_DATE(LAST_SIGNED_ON) >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)
    AND RN = 1
    GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM} 
select CUSTOMER_CDE, 'TOI' FTR_NM, TOI_YEAR ftr_val, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP
from DW_ANALYTICS.dw_customer_full_dim  where CUSTOMER_cde IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    );

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_CT_TXN_1M' FTR_NM,
    COUNT(DISTINCT TXN_ID) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
    AND TXN_STATUS = 'S'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_CT_TXN_3M' FTR_NM,
    COUNT(DISTINCT TXN_ID) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
    AND TXN_STATUS = 'S'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_CT_TXN_6M' FTR_NM,
    COUNT(DISTINCT TXN_ID) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
    AND TXN_STATUS = 'S'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
select A.customer_cde, 'UTILITIES_CT_TXN_12M' FEATURE_NM, count(*) FEATURE_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, mcc_cde,cardhdr_no, 
approval_cde, retrvl_refno,process_dt
from
(
select customer_cde, mcc_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn

from 
(
 select customer_cde, mcc_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM DW_ANALYTICS.DW_CUSTOMER_DIM WHERE SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1')
 )    
         )
where rn = 1
    ) A
JOIN (SELECT * FROM CINS_MCC_CATEGORY where CATEGORY = 'UTILITIES') B 
ON A.MCC_CDE = B.MCC_CDE
group by A.customer_cde;

INSERT INTO {TBL_NM}
select customer_cde,'CARD_FAV_BRANCH_LOC_6M' FTR_NM ,sub_branch_cde FTR_VAL, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, sub_branch_cde, 
       count(*) ct_txn_sub_branch, row_number()over(partition by customer_cde order by count(*) desc) rn1
from
(
select customer_cde, sub_branch_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn from 
(
 select customer_cde, trim(' ' from(sub_branch_cde)) sub_branch_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
))
where rn = 1
group by customer_cde, sub_branch_cde)
where rn1 = 1;

INSERT INTO {TBL_NM}
SELECT A.CUSTOMER_CDE
 ,'CARD_CREDIT_OVER_LIMIT_20_70_6M' AS FTR_NM
 ,CASE WHEN (ROUND(A.AMT_BILL/B.TT_CARD_LIMIT,4) >= 1.2000 AND ROUND(A.AMT_BILL/B.TT_CARD_LIMIT,4) <= 1.7000) THEN 1
     ELSE 0 
     END AS FTR_VAL
 ,TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT
 ,CURRENT_TIMESTAMP AS ADD_TSTP
FROM
(
SELECT CUSTOMER_CDE, SUM(AMT_BILL) AS AMT_BILL FROM CINS_TMP_CREDIT_CARD_TRANSACTION  
 WHERE CUSTOMER_CDE IS NOT NULL
 AND ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6) <= PROCESS_DT AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
 GROUP BY CUSTOMER_CDE
) A
LEFT JOIN 
(SELECT CUSTOMER_CDE, SUM(TT_CARD_LIMIT)*6 AS TT_CARD_LIMIT FROM CINS_TMP_DATA_RPT_CARD_{RPT_DT} GROUP BY CUSTOMER_CDE) B 
 ON A.CUSTOMER_CDE = B.CUSTOMER_CDE;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 
    'CASA_HOLD' AS FTR_NM,
    '1' AS FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP AS ADD_TSTP
    FROM 
    (
 SELECT DISTINCT CUSTOMER_CDE
 FROM DW_ANALYTICS.DW_ACCOUNT_MASTER_DIM
 WHERE ACTIVE = 1 AND COMPANY_KEY = 1 AND SUB_SECTOR_CDE IN ('1700','1602')
 AND CATEGORY_CDE LIKE '10__' AND TO_CHAR(CLOSE_DT) = '01-JAN-00'
 AND OPEN_DT <= TO_DATE('{RPT_DT}','DD-MM-YY')
 AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
    );
COMMIT;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_DAY_SINCE_LTST_TXN' FTR_NM,
    TO_DATE('{RPT_DT}','DD-MM-YY') - NVL(MAX(PROCESS_DT), ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID;

INSERT INTO {TBL_NM}
SELECT DISTINCT CUSTOMER_CDE,
    'EB_MBIB_HOLD' FTR_NM,
    1 FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EB_USER
WHERE PROCESS_DT IN
    (SELECT MAX(PROCESS_DT)
    FROM DW_ANALYTICS.DW_EB_USER
    WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
    )
    AND DEL_FLG = 'N'
    AND CUSTOMER_CDE IN
    (SELECT CUSTOMER_CDE
    FROM CINS_TMP_CUST);

INSERT INTO {TBL_NM}
select A.customer_cde, 'FOOD_GROCERY_CT_TXN_12M' FEATURE_NM, count(*) FEATURE_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, mcc_cde,cardhdr_no, 
approval_cde, retrvl_refno,process_dt
from
(
select customer_cde, mcc_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn

from 
(
 select customer_cde, mcc_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM DW_ANALYTICS.DW_CUSTOMER_DIM WHERE SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1')
 )    
         )
where rn = 1
    ) A
JOIN (SELECT * FROM CINS_MCC_CATEGORY where CATEGORY = 'FOOD_GROCERY') B 
ON A.MCC_CDE = B.MCC_CDE
group by A.customer_cde;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'CARD_CREDIT_SUM_TXN_AMT_1M' FTR_NM,
    NVL(SUM(ABS(AMT_BILL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM CINS_TMP_CREDIT_CARD_TRANSACTION
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE, 
    'CARD_CREDIT_SUM_TXN_AMT_3M' FTR_NM, 
    NVL(SUM(ABS(AMT_BILL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM CINS_TMP_CREDIT_CARD_TRANSACTION
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'CARD_CREDIT_SUM_TXN_AMT_6M' FTR_NM,
    NVL(SUM(ABS(AMT_BILL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM CINS_TMP_CREDIT_CARD_TRANSACTION
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'CARD_CREDIT_SUM_TXN_AMT_12M' FTR_NM,
    NVL(SUM(ABS(AMT_BILL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM CINS_TMP_CREDIT_CARD_TRANSACTION
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_SUM_TXN_AMT_1M' FTR_NM,
    NVL(SUM(ABS(AMT_LCY)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_SUM_TXN_AMT_3M' FTR_NM,
    NVL(SUM(ABS(AMT_LCY)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_SUM_TXN_AMT_6M' FTR_NM,
    NVL(SUM(ABS(AMT_LCY)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_SUM_TXN_AMT_12M' FTR_NM,
    NVL(SUM(ABS(AMT_LCY)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 'FAV_POS_6M_SM' FTR_NM,  MERCHANT_CDE ||'-'||terminal_id FTR_VAL,TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP  FROM
(
SELECT CUSTOMER_CDE, MERCHANT_CDE, TERMINAL_ID, RPT_DT, AMT_BILL, ADD_TSTP,
ROW_NUMBER()OVER(PARTITION BY CUSTOMER_CDE ORDER BY AMT_BILL DESC) RN1
FROM
(

(
SELECT * FROM POS_TERMINAL_AMT_6M
WHERE to_date(RPT_DT,'DD-MM-YY') = to_date('{RPT_DT}','DD-MM-YY'))
UNION  ALL
(
SELECT * FROM POS_MERCHANT_AMT_6M
WHERE to_date(RPT_DT,'DD-MM-YY') = to_date('{RPT_DT}','DD-MM-YY'))

 ) 
 ) WHERE RN1 = 1;

INSERT INTO {TBL_NM}
SELECT DISTINCT CUSTOMER_CDE,
    'EB_SACOMPAY_HOLD' FTR_NM,
    1 FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EWALL_USER_DIM
WHERE FIRST_SIGNED_ON < TO_DATE('{RPT_DT}','DD-MM-YY')
 AND CUSTOMER_CDE IN
  (SELECT CUSTOMER_CDE
  FROM CINS_TMP_CUST);

INSERT INTO {TBL_NM} 
select CUSTOMER_CDE, 'TOI_LST_YR' FTR_NM, toi_ly ftr_val, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP
from DW_ANALYTICS.dw_customer_full_dim where CUSTOMER_cde IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    );

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_SUM_TXN_AMT_1M' FTR_NM,
    NVL(SUM((TO_AMT)), 0) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, PROCESS_DT, ABS(TO_AMT) TO_AMT
    FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
    WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
        AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
        AND TXN_STATUS = 'S'
        AND CUSTOMER_CDE IN (
            SELECT CUSTOMER_CDE 
            FROM CINS_TMP_CUST)
    ) TXN
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_SUM_TXN_AMT_3M' FTR_NM,
    NVL(SUM((TO_AMT)), 0) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, PROCESS_DT, ABS(TO_AMT) TO_AMT
    FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
    WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
        AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
        AND TXN_STATUS = 'S'
        AND CUSTOMER_CDE IN (
            SELECT CUSTOMER_CDE 
            FROM CINS_TMP_CUST)
    ) TXN
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_SUM_TXN_AMT_6M' FTR_NM,
    NVL(SUM((TO_AMT)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, PROCESS_DT, ABS(TO_AMT) TO_AMT
    FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
    WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
        AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
        AND TXN_STATUS = 'S'
        AND CUSTOMER_CDE IN (
            SELECT CUSTOMER_CDE 
            FROM CINS_TMP_CUST)
    ) TXN
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'EB_SACOMPAY_DAY_SINCE_LTST_TXN' FTR_NM,
    TO_DATE('{RPT_DT}','DD-MM-YY') - NVL(MAX(PROCESS_DT), ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)) FTR_VAL,
 TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_EWALL_TRANSACTION_FCT
WHERE PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -36)
AND TXN_STATUS = 'S'
AND CUSTOMER_CDE IN (
    SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST)
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
select A.customer_cde, 'CASH_CT_TXN_12M' FEATURE_NM, count(*) FEATURE_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, mcc_cde,cardhdr_no, 
approval_cde, retrvl_refno,process_dt
from
(
select customer_cde, mcc_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn

from 
(
 select customer_cde, mcc_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM DW_ANALYTICS.DW_CUSTOMER_DIM WHERE SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1')
 )    
         )
where rn = 1
    ) A
JOIN (SELECT * FROM CINS_MCC_CATEGORY where CATEGORY = 'CASH') B 
ON A.MCC_CDE = B.MCC_CDE
group by A.customer_cde;



INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'GEN_GRP' FTR_NM,
    CASE
        WHEN EXTRACT(YEAR FROM BIRTHDAY) < 1965 THEN 'Trước Gen X'
        WHEN EXTRACT(YEAR FROM BIRTHDAY) BETWEEN 1965 AND 1980 THEN 'Gen X'
        WHEN EXTRACT(YEAR FROM BIRTHDAY) BETWEEN 1981 AND 1996 THEN 'Gen Y'
        WHEN EXTRACT(YEAR FROM BIRTHDAY) BETWEEN 1997 AND 2012 THEN 'Gen Z'
        WHEN EXTRACT(YEAR FROM BIRTHDAY) BETWEEN 2013 AND 2025 THEN 'Gen A'
    END FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DW_CUSTOMER_DIM
WHERE ACTIVE = 1
    AND COMPANY_KEY = 1
    AND SUB_SECTOR_CDE IN ('1700', '1602')
    AND CUS_OPEN_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
    AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST);
COMMIT;

INSERT INTO {TBL_NM} 
select customer_cde, 'CASH_SM_AMT_12M' FEATURE_NM, sum(A.AMT_BILL) FEATURE_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, mcc_cde, 
        AMT_BILL
from
(
select customer_cde, mcc_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, AMT_BILL,
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn

from 
(
 select customer_cde, mcc_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno, ABS(AMT_BILL) AMT_BILL,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM DW_ANALYTICS.DW_CUSTOMER_DIM WHERE SUB_SECTOR_CDE IN ('1700','1602') AND ACTIVE = '1' AND COMPANY_KEY = '1')
 )    
         )
where rn = 1
             ) A
JOIN (SELECT * FROM CINS_MCC_CATEGORY where CATEGORY = 'CASH') B 
ON A.MCC_CDE = B.MCC_CDE
GROUP BY a.CUSTOMER_CDE;




---ADDR_TOWN 

INSERT INTO {TBL_NM}
SELECT A.CUSTOMER_CDE, 'ADDR_TOWN' FTR_NM, A.TOWN_COUNTRY FTR_VAL, TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP
FROM
(SELECT CUSTOMER_CDE,TOWN_COUNTRY
FROM DW_ANALYTICS.DW_CUSTOMER_DIM WHERE SUB_SECTOR_CDE IN ('1700','1602') 
AND ACTIVE = '1' AND COMPANY_KEY = '1' AND CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
 )A; 
COMMIT;
 
 
 
INSERT INTO {TBL_NM}
with tbl as (
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_FAV_BRANCH_6M' FTR_NM,
    company_code,
    COUNT(STMT_ENTRY_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT ,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'),-6)
AND substr(DW_ANALYTICS.get_split_column(TXN.inputter,2,'_'),0,6) not like 'IDATM%' 
and substr(DW_ANALYTICS.get_split_column(TXN.inputter,2,'_'),0,8) not like '%IDGW%'
and company_code is not null
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID, company_code)
,NEWTBL as (
select tbl.* from (
select CUSTOMER_CDE, max(ftr_val) ftr_val from tbl group by CUSTOMER_CDE) a
join tbl on a.CUSTOMER_CDE=tbl.CUSTOMER_CDE and a.ftr_val=tbl.ftr_val)

select CUSTOMER_CDE, ftr_nm, ftr_val, rpt_dt, add_tstp FROM (
select CUSTOMER_CDE, ftr_nm, company_code ftr_val, rpt_dt, add_tstp
,row_number() over (partition by CUSTOMER_CDE ORDER BY  COMPANY_CODE DESC) AS RN 
FROM NEWTBL) WHERE RN = 1;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE,
    'EB_MBIB_SUM_TXN_AMT_1M' FTR_NM,
    NVL(SUM(ABS(AMT_ENTRY_LCL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, TXN_DT, AMT_ENTRY_LCL 
    FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
    WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY') AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
    ) TXN
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_MBIB_SUM_TXN_AMT_3M' FTR_NM,
    NVL(SUM(ABS(AMT_ENTRY_LCL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, TXN_DT, AMT_ENTRY_LCL 
    FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
    WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
    ) TXN
GROUP BY CUSTOMER_CDE
UNION ALL
SELECT CUSTOMER_CDE,
    'EB_MBIB_SUM_TXN_AMT_6M' FTR_NM,
    NVL(SUM(ABS(AMT_ENTRY_LCL)), 0) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM 
    (SELECT DISTINCT TXN_ID, CUSTOMER_CDE, TXN_DT, AMT_ENTRY_LCL
    FROM DW_ANALYTICS.DW_EB_TRANSACTION_FCT
    WHERE TXN_DT < TO_DATE('{RPT_DT}','DD-MM-YY') 
    AND TXN_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
    AND TXN_STATUS = 'SUC'
    AND CUSTOMER_CDE IN (
        SELECT CUSTOMER_CDE 
        FROM CINS_TMP_CUST)
    )TXN
GROUP BY CUSTOMER_CDE;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 'EB_MBIB_DAY_SINCE_ACTIVE' FTR_NM, TO_DATE('{RPT_DT}','DD-MM-YY') - ACTIVATE_DATE FTR_VAL,TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
CURRENT_TIMESTAMP ADD_TSTP
FROM
(
select CUSTOMER_CDE,min(ACTIVATE_DT) ACTIVATE_DATE
from DW_ANALYTICS.DW_EB_USER t1
where exists (select 1 from CINS_TMP_CUST t2 where t1.CUSTOMER_CDE=t2.CUSTOMER_CDE) 
AND TO_DATE(ACTIVATE_DT) <= TO_DATE('{RPT_DT}','DD-MM-YY') AND ACTIVATE_DT != TO_DATE('01/01/2400','DD/MM/YYYY')
group by customer_cde) A;

INSERT INTO {TBL_NM}
select customer_cde, 'CARD_TOP3_MERCHANT_6M' FTR_NM, merchant_cde FTR_VAL , TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,CURRENT_TIMESTAMP ADD_TSTP from 
(
select customer_cde, merchant_cde, 
       count(*) ct_txn_merchant, row_number()over(partition by customer_cde order by count(*) desc) rn1
from
(
select customer_cde, merchant_cde,cardhdr_no, 
        approval_cde, retrvl_refno,
        process_dt, 
        row_number()over(partition by customer_cde,cardhdr_no, approval_cde, retrvl_refno order by process_dt desc) rn from 
(
 select customer_cde, trim(' ' from(merchant_cde)) merchant_cde,cardhdr_no, 
        trim(' ' from (approval_cde)) approval_cde, retrvl_refno,
        process_dt
        from DW_ANALYTICS.dw_card_transaction_fct
        where process_dt < TO_DATE('{RPT_DT}','DD-MM-YY') AND process_dt >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
        and tran_status = 'S' 
        and  CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_CUST)
 ))
where rn = 1
group by customer_cde, merchant_cde)
where rn1 = 3;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_CDE, 'FAV_POS_6M_CT' FTR_NM,  MERCHANT_CDE ||'-'||terminal_id FTR_VAL,TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT, CURRENT_TIMESTAMP ADD_TSTP  FROM
(
SELECT CUSTOMER_CDE, MERCHANT_CDE, TERMINAL_ID, RPT_DT, CT_TXN_TERMINAL, ADD_TSTP,
ROW_NUMBER()OVER(PARTITION BY CUSTOMER_CDE ORDER BY CT_TXN_TERMINAL DESC) RN1
FROM (
(
SELECT * FROM POS_MERCHANT_6M WHERE to_date(RPT_DT,'DD-MM-YY') = to_date('{RPT_DT}','DD-MM-YY')
)
UNION  ALL
(
SELECT CUSTOMER_CDE,MERCHANT_CDE,TERMINAL_ID,TO_CHAR(RPT_DT),CT_TXN_TERMINAL,ADD_TSTP FROM POS_TERMINAL_6M WHERE to_date(RPT_DT,'DD-MM-YY') = to_date('{RPT_DT}','DD-MM-YY')
)
    )
 ) WHERE RN1 = 1;

INSERT INTO {TBL_NM}
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_CT_TXN_1M' FTR_NM,
    COUNT(STMT_ENTRY_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -1)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_CT_TXN_3M' FTR_NM,
    COUNT(STMT_ENTRY_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -3)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_CT_TXN_6M' FTR_NM,
    COUNT(STMT_ENTRY_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -6)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID
UNION ALL
SELECT CUSTOMER_ID CUSTOMER_CDE,
    'CASA_CT_TXN_12M' FTR_NM,
    COUNT(STMT_ENTRY_ID) FTR_VAL,
    TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
    CURRENT_TIMESTAMP ADD_TSTP
FROM DW_ANALYTICS.DWA_STMT_EBANK TXN
JOIN (SELECT TRANSACTION_CODE FROM DW_ANALYTICS.TRANSACTION_CODE WHERE INITIATION = 'CUSTOMER') TC
 ON TXN.TRANSACTION_CODE = TC.TRANSACTION_CODE
WHERE PRODUCT_CATEGORY LIKE '10__'
AND PROCESS_DT < TO_DATE('{RPT_DT}','DD-MM-YY')
AND PROCESS_DT >= ADD_MONTHS(TO_DATE('{RPT_DT}','DD-MM-YY'), -12)
AND CUSTOMER_ID IN 
    (SELECT CUSTOMER_CDE 
    FROM CINS_TMP_CUST
    )
GROUP BY CUSTOMER_ID;


INSERT /*+APPEND*/ INTO {TBL_NM}
SELECT 
CUSTOMER_CDE,
'CARD_CREDIT_NON_DEBT_GRP_6M' AS FTR_NM,
CASE WHEN CUSTOMER_CDE IN (SELECT CUSTOMER_CDE FROM CINS_TMP_DATA_RPT_LOAN_{RPT_DT} WHERE TT_LOAN_GROUP = 1) THEN 1
ELSE 0 END AS FTR_VAL,
TO_CHAR(TO_DATE('{RPT_DT}','DD-MM-YY'), 'DD-MM-YYYY') AS RPT_DT,
CURRENT_TIMESTAMP AS ADD_TSTP
FROM CINS_TMP_CARD_CREDIT_LOAN_6M_{RPT_DT} 
WHERE CUSTOMER_CDE IS NOT NULL
AND CUSTOMER_CDE <> '-1' AND CUSTOMER_CDE <> '1'
AND RN = 1